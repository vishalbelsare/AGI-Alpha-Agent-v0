# syntax=docker/dockerfile:1.6
##############################################################################
#  Alphaâ€‘FactoryÂ v1 ðŸ‘ï¸âœ¨ â€” Multiâ€‘Agent AGENTICÂ Î±â€‘AGI                         #
#  Universal Runtime Image (CPUâ€‘only by default, CUDA optional)              #
#                                                                            #
#  â€¢ StageÂ 0  â”€ Build the Traceâ€‘graph web UI with Node/Vite (if present).    #
#  â€¢ StageÂ 1  â”€ Hardened Python runtime with the OpenAI AgentsÂ SDK,          #
#               GoogleÂ ADK (optional), and all project deps preâ€‘installed.   #
#                                                                            #
#  Build switches                                                            #
#  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  #
#  BASE_IMAGE           â€‘ Parent image for StageÂ 1 (defaultÂ python:3.11).    #
#                        Pass  nvidia/cuda:12.4.0-runtimeâ€‘ubuntu22.04        #
#                        for a GPUâ€‘enabled variant.                          #
#  INSTALL_UI           â€‘ Set to "0" to skip the UI build stage.           #
##############################################################################

#######################################################################
#  Global ARGs must precede every FROM that references them           #
#######################################################################
ARG BASE_IMAGE=python:3.11-slim-bookworm
ARG INSTALL_UI=1

#######################################################################
#  StageÂ 0 â€” (optional) Build static Traceâ€‘graph frontâ€‘end            #
#######################################################################
FROM node:20-bookworm-slim AS ui-build
ARG INSTALL_UI
RUN if [ "$INSTALL_UI" = "0" ]; then echo "Skipping UI build stage" && exit 0; fi
WORKDIR /ui
COPY ui/package*.json ./          # leverage Docker layer cache
RUN if [ "$INSTALL_UI" = "1" ]; then npm ci --omit=dev; fi
COPY ui/ .
RUN if [ "$INSTALL_UI" = "1" ]; then npm run build; fi             # â†’ dist/

#######################################################################
#  StageÂ 1 â€” Python Runtime                                           #
#######################################################################
FROM ${BASE_IMAGE} AS runtime
LABEL org.opencontainers.image.title="Alpha-Factory Runtime" \
      org.opencontainers.image.source="https://github.com/MontrealAI/AGI-Alpha-Agent-v0"

#############################
# 1) Environment variables   #
#############################
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    DEBIAN_FRONTEND=noninteractive \
    PYTHONPATH=/app

#############################
# 2) System packages         #
#############################
# gcc & make  â†’ compile Python wheels
# libopenblas + libomp â†’ faissâ€‘cpu & numpy optimised BLAS
# git          â†’ selfâ€‘healing demo (patch commit)
# curl, caâ€‘certificates â†’ healthâ€‘check & diagnostics
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        build-essential \
        git \
        libopenblas0 \
        libomp5 \
        libstdc++6 \
        postgresql-client \
        patch \
        curl ca-certificates && \
    rm -rf /var/lib/apt/lists/*

#############################
# 3) Python dependencies     #
#############################
WORKDIR /app

# -- Strict, reproducible lock (if present) ---------------------------
COPY requirements-lock.txt /tmp/requirements-lock.txt
# -- Project topâ€‘level requirements (edited by humans) ----------------
COPY backend/requirements.txt /tmp/requirements.txt

#  The lock file is preferred (if the project maintains one).  
#  Fallback to plain requirements for dev checkouts.
RUN if [ -f /tmp/requirements-lock.txt ]; then \
        pip install --no-cache-dir -r /tmp/requirements-lock.txt; \
    else \
        pip install --no-cache-dir -r /tmp/requirements.txt; \
    fi && \
    # â¬‡ Explicitly ensure critical agent frameworks are present
    pip install --no-cache-dir \
        openai-agents>=0.0.16 \   # OpenAI AgentsÂ SDK (beta)
        "google-adk @ git+https://github.com/google/adk-python@main#egg=google-adk" \
        anthropic>=0.21 \
        gunicorn rocketry prometheus-client && \
    rm -rf /tmp/requirements-lock.txt /tmp/requirements.txt

#############################
# 4) Copy project source     #
#############################
COPY backend/        /app/backend/
COPY ui/             /app/ui/
COPY entrypoint.sh   /app/entrypoint.sh
RUN chmod +x /app/entrypoint.sh

#############################
# 5) (optional) UI bundle    #
#############################
ARG INSTALL_UI
COPY --from=ui-build /ui/dist/ /app/static/trace/

#############################
# 6) Non-root user           #
#############################
RUN addgroup --system alphafactory && \
    adduser --system --ingroup alphafactory --home /app alphafactory && \
    chown -R alphafactory:alphafactory /app
USER alphafactory

#############################
# 7) Healthâ€‘check           #
#############################
HEALTHCHECK --interval=30s --timeout=10s --retries=3 CMD curl -f http://localhost:8000/health || exit 1

#############################
# 8) Ports & Entrypoint      #
#############################
EXPOSE 8000 3000
CMD ["/app/entrypoint.sh"]
