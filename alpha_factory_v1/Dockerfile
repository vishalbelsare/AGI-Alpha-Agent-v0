# syntax=docker/dockerfile:1.6
##############################################################################
#  Alphaâ€‘Factory v1 ðŸ‘ï¸âœ¨ â€” Multiâ€‘Agent AGENTIC Î±â€‘AGI                         #
#  Productionâ€‘grade Dockerfile (CPU/GPU toggle + Traceâ€‘graph UI)             #
#                                                                            #
#  Key upgrades vs original:                                                 #
#  â€¢ Installs OpenAI Agents SDK (+ optional ADK & Anthropic)                 #
#  â€¢ Keeps UI build stage (Node/Vite) with aggressive caching                #
#  â€¢ Single BASE_IMAGE arg lets you switch to CUDA runtime in one flag       #
#      docker build --build-arg BASE_IMAGE=nvidia/cuda:12.4.0-runtime-ubuntu22.04 . #
#  â€¢ Adds system libs for faiss, openâ€‘blas, etc.                             #
#  â€¢ Uses requirementsâ€‘lock.txt if present for reproducibility               #
##############################################################################

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  âžŠ  Global buildâ€‘arg MUST appear *before* any FROM that references it
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ARG BASE_IMAGE=python:3.11-slim-bookworm   # default â†’ CPUâ€‘only layer

##############################################################################
#  Stage 0 â€“ Build the Traceâ€‘graph UI (Node / Vite)                           #
##############################################################################
FROM node:20-bookworm-slim AS ui-build

WORKDIR /ui
COPY ui/package*.json ./                        # leverage Docker cache for npm ci
RUN npm ci --omit=dev
COPY ui/ .
RUN npm run build                               # â†’ dist/ index.html + assets

##############################################################################
#  Stage 1 â€“ Python runtime                                                   #
##############################################################################
FROM ${BASE_IMAGE} AS runtime

# â”€â”€ Environment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    DEBIAN_FRONTEND=noninteractive \
    PYTHONPATH=/app

# â”€â”€ System libs & toolâ€‘chain (gcc for wheels, BLAS/OpenMP for faiss) â”€â”€â”€â”€â”€â”€â”€
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        build-essential \
        git \
        rustc \
        libopenblas0 \
        libomp5 \
        libstdc++6 && \
    rm -rf /var/lib/apt/lists/*

# â”€â”€ Python dependencies (reproducible lock if available) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
WORKDIR /app
# Copy requirements early to maximise Docker cache hits
COPY backend/requirements.txt /tmp/requirements.txt
COPY requirements-lock.txt    /tmp/requirements-lock.txt

RUN set -e; \
    if [ -f /tmp/requirements-lock.txt ]; then \
        pip install --no-cache-dir -r /tmp/requirements-lock.txt; \
    else \
        pip install --no-cache-dir -r /tmp/requirements.txt; \
    fi && \
    # Core agent ecosystem (install here to ensure presence, even if not in req)
    pip install --no-cache-dir --upgrade \
        'openai-agents>=0.1.0' \
        'google-adk>=0.2.0' \
        'anthropic>=0.27.0' \
        ccxt \
        ortools \
        faiss-cpu \
        feedparser \
        newsapi-python \
        gitpython \
        neo4j \
        psycopg2-binary

# â”€â”€ Project source code â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
COPY backend/        /app/backend/
COPY entrypoint.sh   /app/entrypoint.sh
RUN chmod +x /app/entrypoint.sh

# â”€â”€ Preâ€‘built Traceâ€‘graph UI bundle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
COPY --from=ui-build /ui/dist/ /app/static/trace/

# â”€â”€ Lightweight runtime helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
RUN pip install --no-cache-dir \
        gunicorn \
        rocketry \
        prometheus-client

# â”€â”€ Ports & default CMD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
EXPOSE 8000 3000
CMD ["/app/entrypoint.sh"]
