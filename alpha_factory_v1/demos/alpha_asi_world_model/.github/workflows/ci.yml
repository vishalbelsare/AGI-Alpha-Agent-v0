# ðŸ“¦ Alphaâ€‘Factory v1 CIÂ ðŸŒŸ â€” GitHubÂ Actions Workflow
#
# This workflow validates, testsÂ & hardens the Î±â€‘ASI worldâ€‘model demo.
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# â€†âœ”Â Unitâ€‘testsâ€ƒâ€†âœ”Â Staticâ€‘analysisâ€ƒâ€†âœ”Â Securityâ€‘scanâ€ƒâ€†âœ”Â Docker build & smokeâ€‘test
# â€†âœ”Â Helm lintâ€ƒâ€†âœ”Â Multiâ€‘Python matrixâ€ƒâ€†âœ”Â Artifact uploadâ€ƒâ€†âœ”Â Cache optimisation
#
# It is engineered for *antifragility*: failures trigger deeper diagnostics and
# never leak secrets.  Runs fine with *or without* OPENAI_API_KEY.
#
# DocsÂ âž¡Â https://github.com/MontrealAI/AGI-Alpha-Agent-v0
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
name: ðŸš€ CI / CD â€” Alphaâ€‘ASI Demo

on:
  push:
    branches: [ main, 'release/**' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: {}

permissions:
  contents: read
  actions: read
  checks: write
  id-token: write    # OIDC for registries (optional)

concurrency:
  group: ${{ github.workflow }}â€‘${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION_MATRIX: '3.10,3.11,3.12'
  DOCKER_IMAGE: alpha-asi-world-model
  HELM_CHART_PATH: alpha_factory_v1/demos/alpha_asi_world_model/helm_chart

jobs:
  ########################
  # 1ï¸âƒ£  Lint & Typing   #
  ########################
  lint-typecheck:
    name: 'ðŸ§¹ Ruff + ðŸ·ï¸Â Mypy'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [${{ env.PYTHON_VERSION_MATRIX }}]
    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: ðŸ“¦ Install deps (minimal)
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy

      - name: ðŸ§¹ Ruff lint
        run: ruff .

      - name: ðŸ·ï¸Â Mypy typeâ€‘check
        run: mypy alpha_factory_v1/demos/alpha_asi_world_model --strict

  ########################
  # 2ï¸âƒ£  UnitÂ &Â Smoke    #
  ########################
  test:
    name: 'âœ… UnitÂ tests'
    needs: lint-typecheck
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [${{ env.PYTHON_VERSION_MATRIX }}]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: ðŸ“¦ Install project deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: ðŸ§ª Run pytest
        run: |
          pytest -q --cov=alpha_factory_v1/demos/alpha_asi_world_model --cov-report=xml                  --cov-report=term-missing

      - name: ðŸ“Š Upload coverage (Codecov optional)
        if: ${{ env.CODECOV_TOKEN != '' }}
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.xml

      - name: ðŸ“¥ Upload artefacts
        uses: actions/upload-artifact@v4
        with:
          name: testâ€‘reportsâ€‘py${{ matrix.python-version }}
          path: |
            .pytest_cache
            coverage.xml

  ########################
  # 3ï¸âƒ£  Docker Build    #
  ########################
  docker:
    name: 'ðŸ³ Docker build & smokeâ€‘test'
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ—ï¸Â Build container
        run: |
          docker build -t $DOCKER_IMAGE:ci .

      - name: ðŸ” Trivy vulnerability scan
        uses: aquasecurity/trivy-action@0.16.2
        with:
          image-ref: ${{ env.DOCKER_IMAGE }}:ci
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'

      - name: ðŸš¦ Smokeâ€‘test container
        run: |
          docker run -d -p 7860:7860 --name asi_demo $DOCKER_IMAGE:ci --demo --host 0.0.0.0
          sleep 20
          curl -sf http://localhost:7860/agents | jq '. | length'
          docker logs asi_demo --tail 20

  ########################
  # 4ï¸âƒ£  HelmÂ Lint       #
  ########################
  helm:
    name: 'â›µ Helm lint'
    needs: docker
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: â›µ Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: ðŸ” Helm lint
        run: helm lint $HELM_CHART_PATH

  #####################################
  # 5ï¸âƒ£  Release (manual / tag)       #
  #####################################
  release:
    name: 'ðŸš€ Publish Docker + Helm'
    if: startsWith(github.ref, 'refs/tags/')
    needs: helm
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ Setup Python (for packaging)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ”‘ Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ—ï¸Â Reâ€‘build image (release)
        run: |
          docker build -t ghcr.io/${{ github.repository_owner }}/$DOCKER_IMAGE:${{ github.ref_name }} .
          docker push ghcr.io/${{ github.repository_owner }}/$DOCKER_IMAGE:${{ github.ref_name }}

      - name: ðŸ“¤ Package Helm chart
        run: |
          helm package $HELM_CHART_PATH --destination dist/
          echo "HELM_PKG=$(ls dist/*.tgz)" >> "$GITHUB_ENV"

      - name: ðŸ“¦ Upload Helm artifact
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.HELM_PKG }}
          generate_release_notes: true
